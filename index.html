<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Corsa all'Amore Deluxe+</title>
<style>
    body {
        margin: 0;
        overflow: hidden;
        font-family: 'Comic Sans MS', cursive, sans-serif;
        background: linear-gradient(to bottom, #ffcce6, #ff99cc);
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
    }
    #gameCanvas {
        border: 3px solid #ff3385;
        display: block;
        z-index: 1;
    }
    #message {
        position: absolute;
        top: 10px;
        font-size: 22px;
        color: #ff0066;
        font-weight: bold;
        text-align: center;
        width: 100%;
        z-index: 2;
    }
    #romanticOverlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(255, 204, 230, 0.85);
        display: flex;
        justify-content: center;
        align-items: center;
        font-size: 28px;
        color: #cc0052;
        font-weight: bold;
        text-align: center;
        opacity: 0;
        transition: opacity 1s ease;
        z-index: 3;
    }
    /* Pulsanti freccia */
    #controls {
        position: absolute;
        bottom: 20px;
        width: 100%;
        display: flex;
        justify-content: space-between;
        padding: 0 40px;
        z-index: 4;
    }
    .arrow-btn {
        width: 60px;
        height: 60px;
        border-radius: 50%;
        border: none;
        background: rgba(255, 0, 102, 0.6);
        color: white;
        font-size: 28px;
        font-weight: bold;
        box-shadow: 0px 0px 10px rgba(255,0,102,0.5);
    }
    .arrow-btn:active {
        background: rgba(255, 0, 102, 0.9);
    }
</style>
</head>
<body>
<div id="message">Benvenuto nella Corsa all'Amore! ‚ù§Ô∏è</div>
<canvas id="gameCanvas" width="400" height="600"></canvas>
<div id="romanticOverlay"></div>

<!-- Controlli touch -->
<div id="controls">
    <button class="arrow-btn" id="leftBtn">‚¨ÖÔ∏è</button>
    <button class="arrow-btn" id="rightBtn">‚û°Ô∏è</button>
</div>

<audio id="bgMusic" loop autoplay>
  <source src="audio/dormiamo.mp3" type="audio/mpeg">
</audio>
<audio id="pointSound">
  <source src="https://actions.google.com/sounds/v1/cartoon/clang_and_wobble.ogg" type="audio/ogg">
</audio>
<audio id="levelSound">
  <source src="https://actions.google.com/sounds/v1/cartoon/pop.ogg" type="audio/ogg">
</audio>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');
const overlay = document.getElementById("romanticOverlay");

// Cuore giocatore
const heart = {
    x: canvas.width/2 - 25,
    y: canvas.height - 70,
    width: 50,
    height: 50,
    speed: 6,
    color: 'red'
};

let obstacles = [];
let fallingHearts = [];
let explosionHearts = [];
let score = 0;
let level = 1;
let paused = false;

const keys = {};
document.addEventListener('keydown', e => keys[e.key] = true);
document.addEventListener('keyup', e => keys[e.key] = false);

// Freccette touch
let leftPressed = false;
let rightPressed = false;

document.getElementById("leftBtn").addEventListener("touchstart", () => leftPressed = true);
document.getElementById("leftBtn").addEventListener("touchend", () => leftPressed = false);

document.getElementById("rightBtn").addEventListener("touchstart", () => rightPressed = true);
document.getElementById("rightBtn").addEventListener("touchend", () => rightPressed = false);

// Messaggi romantici
const romanticMessages = [
    "Sei la mia stella che illumina il cammino ‚ú®",
    "Ogni battito del mio cuore √® per te ‚ù§Ô∏è",
    "Vorrei restare con te per sempre üíû",
    "Il tuo amore √® il mio dono pi√π grande üéÅ",
    "Con te il mondo √® pi√π bello üå∏",
    "Il mio cuore ti appartiene üíñ",
    "Sei il mio destino üåπ",
    "Ti amo pi√π di quanto le parole possano dire üíì",
    "Senza di te nulla avrebbe senso üíò",
    "Sei la mia dolce met√† üç´"
];

function spawnObstacle() {
    let size = 35;
    let x = Math.random() * (canvas.width - size);
    obstacles.push({x, y: -size, width: size, height: size, color: '#ff4da6', speed: 2 + level});
}

function spawnFallingHeart() {
    let size = 10 + Math.random() * 10;
    let x = Math.random() * canvas.width;
    fallingHearts.push({x, y: -size, width: size, height: size, speed: 1 + Math.random() * 2, color: '#ffb3d9'});
}

function createExplosion(x, y) {
    for(let i=0; i<25; i++) {
        explosionHearts.push({
            x, y,
            size: 8 + Math.random()*12,
            color: 'red',
            dx: (Math.random()-0.5)*5,
            dy: (Math.random()-0.5)*5,
            life: 60
        });
    }
}

function showRomanticMessage() {
    paused = true;
    const msg = romanticMessages[Math.floor(Math.random()*romanticMessages.length)];
    overlay.textContent = msg;
    overlay.style.opacity = 1;

    setTimeout(() => {
        overlay.style.opacity = 0;
        setTimeout(() => paused = false, 1000);
    }, 2500);
}

function update() {
    if(paused) return;

    // Movimento tastiera
    if(keys['ArrowLeft'] || leftPressed) heart.x -= heart.speed;
    if(keys['ArrowRight'] || rightPressed) heart.x += heart.speed;

    // Limiti movimento
    if(heart.x < 0) heart.x = 0;
    if(heart.x > canvas.width - heart.width) heart.x = canvas.width - heart.width;

    // Ostacoli
    for(let i = obstacles.length - 1; i >= 0; i--) {
        obstacles[i].y += obstacles[i].speed;
        if(obstacles[i].y > canvas.height) {
            obstacles.splice(i,1);
            score++;
            document.getElementById("pointSound").play();
            checkLevelUp();
        }
        if(heart.x < obstacles[i].x + obstacles[i].width &&
           heart.x + heart.width > obstacles[i].x &&
           heart.y < obstacles[i].y + obstacles[i].height &&
           heart.y + heart.height > obstacles[i].y) {
               resetGame("Oh no! Ti sei scontrato!");
               return;
        }
    }

    // Cuoricini sfondo
    for(let i = fallingHearts.length - 1; i >= 0;
